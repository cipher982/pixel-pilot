FROM python:3.12-slim

# Install minimal X11 and system dependencies
RUN apt-get update && apt-get install -y \
    xvfb \
    x11-utils \
    python3-xlib \
    x11vnc \
    xauth \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && pip install uv

WORKDIR /app

# Set up X11 environment
ENV DISPLAY=:99
ENV XAUTHORITY=/tmp/.Xauthority

# Create and set up X11 auth file
RUN touch $XAUTHORITY && \
    xauth add $DISPLAY MIT-MAGIC-COOKIE-1 dead00beef00

# Copy dependency files first
COPY pyproject.toml uv.lock ./

# Install dependencies with dev extras
RUN uv sync --extra dev

# Copy source code
COPY pixelpilot/ pixelpilot/
COPY eval/ eval/
COPY tests/ tests/

# Copy and setup scripts
COPY eval/docker/test-x11.sh /test-x11.sh
RUN chmod +x /test-x11.sh

# Start Xvfb and run tests
ENTRYPOINT ["/test-x11.sh"] 